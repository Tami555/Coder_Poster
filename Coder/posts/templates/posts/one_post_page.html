{% extends 'base.html' %}
{% load static %}

{% block headstyle %}
    <link type="text/css" rel="stylesheet" href="{% static 'posts/css/one_post_page.css' %}">
{% endblock %}

{% block content %}
    <div class="main_block">
        <div class="post-header">
            <h2 class="post-title">{{post.title}}</h2>
            <p class="post-description">{{post.description}}</p>
        </div>

        <div class="post-image-wrapper">
            <img src="{{post.image.url}}" class="post-image" alt="{{post.title}}">
        </div>

        <div class="post-meta">
            <div class="author-info">
                <div class="meta-item">
                    <span class="meta-label">Автор:</span>
                    <a href="{% url 'users:profile' post.coder.pk %}" class="author-link">
                        {% if post.coder.username == user.username %}
                            Вы
                        {% elif post.coder.first_name %}
                            {{post.coder.first_name}} {{post.coder.last_name}}
                        {% else %}
                            {{post.coder.username}}
                        {% endif %}
                    </a>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Обновлено:</span>
                    <span class="meta-value">{{post.data_update|date:"SHORT_DATE_FORMAT"}}</span>
                </div>
            </div>

            <div class="category-tags">
                <div class="meta-item">
                    <span class="meta-label">Категория:</span>
                    <a href="{{post.category.get_absolute_url}}" class="category-link">{{post.category.title}}</a>
                </div>

                <!-- БЛОК СТАТУСА -->
                <div class="meta-item">
                    <span class="meta-label">Статус:</span>
                    <span class="status-badge
                        {% if post.status == 'approved' %}status-approved{% endif %}
                        {% if post.status == 'blocked' %}status-blocked{% endif %}
                        {% if post.status == 'check' %}status-check{% endif %}">
                        {% if post.status == 'approved' %}Опубликован{% endif %}
                        {% if post.status == 'blocked' %}Заблокирован{% endif %}
                        {% if post.status == 'check' %}На проверке{% endif %}
                    </span>
                </div>

                <div class="tags-container">
                    {% for t in post.tags.all %}
                        <a href="{{t.get_absolute_url}}" class="tag-link">{{t.title}}</a>
                    {% endfor %}
                </div>
            </div>

            {% if user.pk == post.coder.pk and post.status != 'check' %}
                <div class="post-actions">
                    <a class="post-action-btn edit-btn" href="{% url 'edit_post' post.slug %}">
                        <svg class="btn-icon" viewBox="0 0 24 24">
                            <path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" />
                        </svg>
                        <span>Редактировать</span>
                    </a>
                    <a class="post-action-btn delete-btn" href="{% url 'delete_post' post.slug %}">
                        <svg class="btn-icon" viewBox="0 0 24 24">
                            <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" />
                        </svg>
                        <span>Удалить</span>
                    </a>
                </div>
            {% else %}
                <!-- Кнопка подписки -->
                <div class="subscribe-section">
                    <button class="subscribe-btn {% if is_subscribed %}subscribed{% endif %}"
                    data-author-id="{{ post.coder.id }}"
                    data-author-name="{{ post.coder.username }}">
                        <span class="btn-text">
                            {% if is_subscribed %}Вы подписаны{% else %}Подписаться{% endif %}
                        </span>
                        <span class="btn-loader" style="display: none;">
                            <div class="loader"></div>
                        </span>
                    </button>

                <!-- Анимация подписки -->
                    <div class="subscribe-animation">
                        <div class="animation-particle"></div>
                        <div class="animation-particle"></div>
                        <div class="animation-particle"></div>
                    </div>
                </div>

            <!-- Модальное окно подтверждения отписки -->
            <div class="unsubscribe-modal" id="unsubscribe-modal">
                <div class="modal-content">
                    <h3>Подтверждение отписки</h3>
                    <p>Вы уверены, что хотите отписаться от <span id="author-name"></span>?</p>
                    <div class="modal-actions">
                        <button class="modal-btn cancel-btn">Отмена</button>
                        <button class="modal-btn confirm-btn">Отписаться</button>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="post-content">
            {{post.content|linebreaks}}
        </div>

        <div class="reactions-section">
            <h3 class="reactions-title">Оцените пост</h3>

            <div class="reactions-container">
                <!-- Лайк -->
                <div class="reaction-item like-reaction {% if user_reaction == 1 %}active{% endif %}" data-reaction="like">
                    <div class="reaction-icon">
                        <svg class="reaction-svg" viewBox="0 0 24 24">
                            <path d="M23,10C23,8.89 22.1,8 21,8H14.68L15.64,3.43C15.66,3.33 15.67,3.22 15.67,3.11C15.67,2.7 15.5,2.32 15.23,2.05L14.17,1L7.59,7.58C7.22,7.95 7,8.45 7,9V19A2,2 0 0,0 9,21H18C18.83,21 19.54,20.5 19.84,19.78L22.86,12.73C22.95,12.5 23,12.26 23,12V10M1,21H5V9H1V21Z"/>
                        </svg>
                    </div>
                    <span class="reaction-count" id="likes-count">{{ post.get_likes_count }}</span>
                    <div class="reaction-label">Нравится</div>

                    <!-- Анимация салюта -->
                    <div class="confetti-container">
                        {% for i in "x"|rjust:"12" %}
                        <div class="confetti"></div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Дизлайк -->
                <div class="reaction-item dislike-reaction {% if user_reaction == 0 %}active{% endif %}" data-reaction="dislike">
                    <div class="reaction-icon">
                        <svg class="reaction-svg" viewBox="0 0 24 24">
                            <path d="M19,15H23V3H19M15,3H6C5.17,3 4.46,3.5 4.16,4.22L1.14,11.27C1.05,11.5 1,11.74 1,12V14A2,2 0 0,0 3,16H9.31L8.36,20.57C8.34,20.67 8.33,20.78 8.33,20.89C8.33,21.3 8.5,21.68 8.77,21.95L9.83,23L16.41,16.41C16.78,16.05 17,15.55 17,15V5A2,2 0 0,0 15,3Z"/>
                        </svg>
                    </div>
                    <span class="reaction-count" id="dislikes-count">{{ post.get_dislikes_count }}</span>
                    <div class="reaction-label">Не нравится</div>

                    <!-- Анимация "взрыва" -->
                    <div class="explosion-container">
                        {% for i in "x"|rjust:"8" %}
                        <div class="explosion-particle"></div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Сообщение о результате -->
            <div class="reaction-message" id="reaction-message"></div>
        </div>

        <!-- CSRF токен для AJAX -->
        <input type="hidden" id="csrf-token" value="{{ csrf_token }}">
        <input type="hidden" id="post-id" value="{{ post.id }}">
        <input type="hidden" id="user-reaction" value="{{ user_reaction }}">

        {% with maybe_like_posts=post.get_maybe_like_post %}
        {% if maybe_like_posts|length %}
        <h2 class="maybe_like_title">Вам может понравиться: </h2>
            <div class="blocks_maybe_like">
                {% for l in maybe_like_posts %}
                    <div class="like_block">
                        <a href="{{l.get_absolute_url}}">
                            <img src="{{l.image.url}}">
                            <h3>{{l.title}}</h3>
                            <p>{{l.description}}</p>
                            <div class="tags-container">
                                {% for t in l.tags.all %}
                                    <a href="{{t.get_absolute_url}}" class="tag-link">{{t.title}}</a>
                                {% endfor %}
                            </div>
                        </a>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        {%endwith%}
    </div>
{% endblock %}
{% block scripts %}
    <script src="{% static 'posts/js/reactions.js' %}"></script>
    <script src="{% static 'users/js/subscriptions.js' %}"></script>
{% endblock %}